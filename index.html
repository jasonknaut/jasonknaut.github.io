<!doctype html>
<html lang="en">
<head>
  <title>CS498 Data Viz -- Final Project</title>
  <link href="css/main.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Libre+Baskerville|Roboto:100,300,400,700" rel="stylesheet">
  <script type="text/javascript" src="js/slideviz.js"></script>
  <script type="text/javascript" src="https://d3js.org/d3.v4.js"></script>
  <meta charset='utf-8'>
</head>
<body>
  <div id="content">

    <!-- Slide: About this Visualiztion -->
    <div class="slide-contents offscreen left" id="slide-about" data-next="slide-intro">
      <h2 class="center">About This Visualization.</h2>
    </div>

    <!-- Slide: Introduction to the Visualization -->
    <div class="slide-contents" id="slide-intro" data-next="slide-viz1" data-initial data-hidenav>
      <h1 class="center">Take a Ride Through the <br/>New York City Bikeshare System.</h1>
      <div class="byline">
        <a href="https://www.linkedin.com/in/jknaut" target="_blank">
          <img src="images/me_tiny.jpg" />Jason Knaut
        </a>
      </div>
      <p class="abstract">
        In 2017, Citibike&#8212;New York City's bikeshare network&#8212;enabled residents, commuters, and
        visitors to take more than 16 million rides throughout the city. The following visualizations explore
        a year of rides across the city, including utilization across individual bikeshare stations, seasonality,
        and intra-day demand patterns, to bring the network to life.
      </p>
        <button id="about-btn" class="text-btn"><img src="images/info-round.svg" alt="About this Visulization">About this Visualization</button>
        <br />

        <button id="start-btn" class="btn-round pulse"><img src="images/right-arrow.svg" alt="Start"></button>
    </div>

    <!-- Data Viz Slide #1: Monthly Ride Data Plotted on a Geomap of the Citibike System -->
    <div class="slide-contents offscreen right" id="slide-viz1" data-next="slide-viz2" data-prev="slide-intro">
      <h1 class="center">Riders Completed <span id="map-totalrides">{insert}</span> Trips Around New York City in 2017.</h1>
      <div id="ridebarchart-container"></div>
      <div id="mapviz-container" class="clearfix">
        <div id="map-commentary" class="vizslide">
          <h4>Monthly Rides by Station</h4>
          <h3 id="mapviz-currentmonth"></h3>
          <div class="map-stat">
            <span id="mo-stat-rides" class="stat"></span>
            <span class="stat-label">Rides</span>
          </div>
          <div class="map-stat">
            <span id="mo-stat-active" class="stat"></span>
            <span class="stat-label">Active Stations</span>
          </div>
          <div class="map-stat">
            <span id="mo-stat-avg" class="stat"></span>
            <span class="stat-label">Avg. Rides per Station</span>
          </div>
        </div>
        <div id="map-container"></div>
      </div>
    </div>

    <!-- Data Viz Slide #2: Ride Frequency by Day of Week -->
    <div class="slide-contents offscreen right" id="slide-viz2" data-next="slide-viz3" data-prev="slide-viz1">
      <h2 class="center">Slide 3</h2>
    </div>

    <!-- Data Viz Slide #3: Distribution of Rides by Time of Day -->
    <div class="slide-contents offscreen right" id="slide-viz3" data-prev="slide-viz2">
      <h2 class="center">Slide 4</h2>
    </div>


    <!-- Navigation to select slides in the slideshow -->
    <div id="slide-nav" class="hidden">
        <button id="slide-btn1" class="slide-btn selected" data-linkedto="slide-intro"><img src="images/home.svg" alt="Home"></button>
        <button id="slide-btn2" class="slide-btn" data-linkedto="slide-viz1">1</button>
        <button id="slide-btn3" class="slide-btn" data-linkedto="slide-viz2">2</button>
        <button id="slide-btn4" class="slide-btn" data-linkedto="slide-viz3">3</button>
    </div>
  </div>
  <div id="left-nav" class="hidden"><div id="slide-prev-btn" class="btn-round small"><img src="images/left-arrow.svg" alt="Go Back"></div></div>
  <div id="right-nav" class="hidden"><div id="slide-next-btn" class="btn-round small"><img src="images/right-arrow.svg" alt="Go Forward"></div></div>

  <div id="tooltip">Test</div>

  <script type="text/javascript">

    /** ------------- SETUP INTERACTIVE SLIDESHOW UI ------------- **/
    slideviz.setup();

    const monthNames = ["January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];

    const monthNamesShort = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
      "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
    ];


    /** ------------- COLORS ------------- **/
    colors = {
      "white": "#ffffff",
      "navy": "#00192e",
      "dark_blue": "#002040",
      "blue": "#033c66",
      "light_blue": "#13639f",
      "yellow": "#f2b06f",
      "green": "#4ebe97",
      "cyan": "#8bcee2",
      "pink": "#f57295",
      "purple": "#b154aa",
      "dark_purple": "#7c5abf"

    }

    /** ------------- D3 SETUP ------------- **/

    d3.queue()
      .defer(d3.json, "data/nyc-neighborhoods.geojson")
      .defer(d3.csv, "data/citibike_2017_rides_by_station.csv")
      .defer(d3.csv, "data/citibike_2017_rides_by_day_and_hour.csv")
      .defer(d3.csv, "data/citibike_2017_rides_by_weather.csv")
      .await(ready);

    function ready(error, map_data, rides_data, intraday_data, weather_data) {
      create_map_viz(map_data, rides_data);



    }

    /** ------------- RIDES BY STATION VIZ ------------- **/

    function create_map_viz(map_data, rides_data) {
      const chart_width = 800;
      const chart_height = 50;
      const axis_height = 25;
      const map_width = 400;
      const map_height = 500;
      const map_scale = 150000;
      const map_lat = -73.9712;
      const map_long = 40.7331;
      const pt_minr = 3;
      const pt_maxr = 12;
      const pt_opacity = 0.8;

      var selected_month = 1;      // Start the visualization at January.


      /** Create the bar chart with total rides by month **/
      function draw_barchart(update_points) {

        var x = d3.scaleBand().rangeRound([0, chart_width])
        var y = d3.scaleLinear().range([chart_height, 0]);

        // Summarize data by month
        var monthlyrides = d3.nest()
                             .key(function(d) { return +d.ride_month; })
                             .sortKeys((a, b) => d3.ascending(+a, +b))
                             .rollup(function(x) { return d3.sum(x, function(d) {return (d.ride_count)}); })
                             .entries(rides_data);

        x.domain(monthlyrides.map(function(d) { return d.key; }));
        y.domain([0, d3.max(monthlyrides, function(d) { return d.value; })]);

        var svg = d3.select('#ridebarchart-container')
                    .append('svg')
                    .attr('width', chart_width)
                    .attr('height', chart_height + axis_height);

        // Draw bars
        svg.selectAll("rect")
           .data(monthlyrides)
           .enter()
           .append("rect")
           .attr("class", function(d) { return d.key == selected_month ? "bar-selected" : "bar"; })
	         .attr("x", function(d) { return x(d.key); })
	         .attr("y", function(d) { return y(d.value); })
	         .attr("width", x.bandwidth())
	         .attr("height", function(d) { return chart_height - y(d.value); })
           .on("click", click);

        // Add month labels
        svg.selectAll(".xlabel")
           .data(monthNamesShort)
           .enter()
           .append("text")
           .classed("xlabel", true)
           .classed("selected", function(d,i) { return i+1 == selected_month; })
           .attr("x", function(d, i) { return x(i+1) + x.bandwidth() / 2; })
           .attr("y", chart_height+18)
           .text(function(d) { return d; });

        // Update chart month heading
        update(selected_month);

        function update(month_id) {

          // Redraw station points on the map
          update_points(month_id);

          // Format the labels on the bar chart (newly selected month)
          svg.selectAll("text")
             .data(monthNamesShort)
             .transition()
             .duration(200)
             .attr("class", function(d,i) { return i+1 == month_id ? "xlabel selected" : "xlabel"; })

          // Add the selected month to the commentary
          d3.select('#mapviz-currentmonth')
            .transition().duration(150)
            .style("opacity", 0)
            .transition().duration(150)
            .style("opacity", 1)
            .text(monthNames[month_id-1] + " 2017");

          // Update the stats in the commentary
          stats = rideStats(month_id);

          var format = d3.format(",d");

          d3.select('#mo-stat-rides')
            .transition()
            .duration(200)
              .on("start", function repeat() {
                d3.active(this)
                    .tween("text", function() {
                      var that = d3.select(this),
                          i = d3.interpolateNumber(that.text().replace(/,/g, ""), stats.rides);
                      return function(t) { that.text(format(i(t))); };
                    });
              });

          d3.select('#mo-stat-active')
            .transition()
            .duration(200)
              .on("start", function repeat() {
                d3.active(this)
                    .tween("text", function() {
                      var that = d3.select(this),
                          i = d3.interpolateNumber(that.text().replace(/,/g, ""), stats.stations);
                      return function(t) { that.text(format(i(t))); };
                    });
              });

          d3.select('#mo-stat-avg')
            .transition()
            .duration(200)
              .on("start", function repeat() {
                d3.active(this)
                    .tween("text", function() {
                      var that = d3.select(this),
                          i = d3.interpolateNumber(that.text().replace(/,/g, ""), stats.rides_per_station);
                      return function(t) { that.text(format(i(t))); };
                    });
              });

        }


        /** Click event listener for bar clicks **/
        function click(d) {
          d3.select(".bar-selected").attr("class", "bar");
          d3.select(this).attr("class", "bar-selected");
          selected_month = +d.key;
          update(selected_month);
        }

        /** Helper to get the stats for the selected month **/
        function rideStats(month) {
          var stats = d3.nest()
                        .key(function(d) { return d.ride_month; })
                        .rollup(function(v) {
                                  return {
                                    stations: v.length,
                                    rides: d3.sum(v, function(d) { return +d.ride_count; })
                                  }; })
                        .entries(
                          rides_data.filter(function(d) { return +d.ride_month == month & +d.ride_count > 0; })
                        )[0].value;
          stats.rides_per_station = Math.round(stats.rides / stats.stations)
          return stats;

        }

      }

      /** Create the map of NYC **/
      function draw_map() {
        var projection = d3.geoMercator()
                           .scale(map_scale)
                           .center([map_lat, map_long])
                           .translate([map_width / 2, map_height / 2]);

        var path = d3.geoPath().projection(projection);

        var svg = d3.select('#map-container')
                    .append('svg')
                    .attr('width', map_width)
                    .attr('height', map_height);

        var g = svg.append('g');

        var mapLayer = g.append('g').classed('map-layer', true);
        var plotLayer = g.append('g').classed('plot-layer', true);
        var tooltip = d3.select("#tooltip")

        mapLayer.selectAll('path')
                 .data(map_data.features)
                 .enter().append('path')
                 .attr('d', path)
                 .style('fill', colors.blue)
                 .style('stroke', colors.dark_blue);

        var total_rides = d3.sum(rides_data, function(d){return +d.ride_count;});
        d3.select('#map-totalrides').text(Number(total_rides).toLocaleString());

        // Add the stations to the map
        // Group data by station
        var station_data = d3.nest()
                     .key(function(d) { return d.station; }).sortKeys(d3.ascending)
                     .key(function(d) { return d.ride_month; }).sortKeys((a, b) => d3.ascending(+a, +b))
                     .entries(rides_data);

        var max_rides = d3.max(rides_data, function(d) { return +d.ride_count;} );
        var scale = d3.scaleLinear()
                      .domain([0, max_rides])
                      .range([pt_minr, pt_maxr]);

        // Create a gradient scale based on # of rides
        var color_scale = d3.scaleLinear()
                      .domain([0, 0.1 * max_rides, 0.3 * max_rides, .45 * max_rides, max_rides])
                      .range([colors.cyan, colors.purple, colors.dark_purple, colors.yellow, colors.pink]);

        function station_coord(station) {
          lat = +station.values[0].values[0].lat;
          long = +station.values[0].values[0].long;
          return [long, lat];
        }

        function station_rides(station, month) {
          var rides = 0;
          for (var i=0; i < station.values.length; i++) {
            var d = station.values[i];
            if(d.key == String(month)) {
              rides = +d.values[0].ride_count;
            }
          }
          return rides;
        }

        /** Create the initial points for each station **/
        function create_points() {
          plotLayer.selectAll('circle')
                   .data(station_data)
                   .enter().append('circle')
                   .attr("cx", function (d) { return projection(station_coord(d))[0]; })
                   .attr("cy", function (d) { return projection(station_coord(d))[1]; })
                   .attr("r", function (d) { return scale(station_rides(d, selected_month)); })
                   .style("fill", function (d) { return color_scale(station_rides(d, selected_month)); })
                   .style("fill-opacity", pt_opacity)
                   .style("visibility", function (d) { return station_rides(d, selected_month) == 0 ? "hidden" : "visible"; })
                   .attr('stroke',colors.white)
                   .attr('stroke-width',0)
                   .style("cursor", "pointer")
                   .on('mouseover',function(d) {
                                                d3.select(this)
                                                  .transition()
                                                  .duration(100)
                                                  .attr('stroke-width',2);
                                                tooltip.transition()
                                                       .duration(200)
                                                       .style("opacity", 1);
                                                tooltip.html("<span>" + d.key + "</span>" + station_rides(d, selected_month).toLocaleString('en') + " rides in " + monthNames[selected_month-1])
                                                       .style("left", (d3.event.pageX) + 10 + "px")
                                                       .style("top", (d3.event.pageY) + "px");
                                              })
                   .on('mouseout',function() {
                                                d3.select(this)
                                                  .transition()
                                                  .duration(100)
                                                  .attr('stroke-width',0);
                                                tooltip.transition()
                                                       .duration(500)
                                                       .style("opacity", 0);
                                              });
        }

        /** Update callback to refresh the display of station ride counts **/
        function update_points(month_id) {
          plotLayer.selectAll('circle')
                   .data(station_data)
                   .attr("cx", function (d) { return projection(station_coord(d))[0]; })
                   .attr("cy", function (d) { return projection(station_coord(d))[1]; })
                   .attr("r", function (d) { return scale(station_rides(d, month_id)); })
                   .transition()
                   .duration(300)
                   .style("fill", function (d) { return color_scale(station_rides(d, month_id)); })
                   .style("fill-opacity", pt_opacity)
                   .style("visibility", function (d) { return station_rides(d, month_id) == 0 ? "hidden" : "visible"; })
                   .attr('stroke',colors.white)
                   .attr('stroke-width',0)
                   .style("cursor", "pointer")
        }

        create_points();
        return update_points;

      }


      // Initialize the visualization
      updater = draw_map();
      draw_barchart(updater);

     }

    /** ------------- TIME OF DAY DATA VIZ ------------- **/


  </script>
</body>
</html>
